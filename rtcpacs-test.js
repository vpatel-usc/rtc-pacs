"use strict";function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}class RtcPacs{static handleError(err){console.log(err);window.alert(err)}constructor(){this.peer=new Peer(RtcPacs.salt+RtcPacs.adjectives[Math.floor(Math.random()*RtcPacs.adjectives.length)]+RtcPacs.animals[Math.floor(Math.random()*RtcPacs.animals.length)]);this.peer.on("open",this.peerOpen);this.peer.on("disconnected",this.peerDisconnected.bind(this));this.peer.on("close",this.peerClose);this.peer.on("error",RtcPacs.handleError);this.peer.on("connection",this.peerConnection.bind(this));this.peer.on("call",this.peerCall.bind(this));this.codename="";this.controlToggle=false;this.caseSelect="";this.message="";this.chatroom=[];this.controlCodename="";this.rosterList=[];this.dataConnections=[];this.audioStreams=[];this.activeRoster=[this.peer.id];this.viewerLinked=false;this.viewerDirty=false;this.viewerState=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,false];this.lastViewerUpdate=0;this.audioStream=null;this.microphoneState=RtcPacs.microphoneStates.none;navigator.mediaDevices.getUserMedia({audio:true,video:false}).then(function(stream){this.audioStream=stream;this.microphoneState=RtcPacs.microphoneStates.unmuted}.bind(this)).catch(function(err){RtcPacs.handleError(err);RtcPacs.handleError("Microphone permission denied.  This is not going to work.  Look for an icon in the URL bar, grant mic access and reload the page.")})}peerOpen(id){}peerDisconnected(){if(window.confirm("Disconnected from signaling server!  Try to reconnect?")){this.peer.reconnect()}else{}}peerClose(){}peerConnection(dataConnection){dataConnection.on("open",this.connectionOpenIncoming.bind(this));dataConnection.on("close",this.connectionClose.bind(this));dataConnection.on("data",this.connectionData.bind(this));dataConnection.on("error",RtcPacs.handleError)}peerCall(mediaConnection){mediaConnection.answer(this.audioStream,{sdpTransform:this.transformSdp});mediaConnection.on("stream",this.callStream.bind(this));mediaConnection.on("close",this.callClose.bind(this));mediaConnection.on("error",RtcPacs.handleError)}connectionOpenIncoming(){this.refreshRosters();this.broadcastRoster()}connectionOpenOutgoing(){this.refreshRosters()}connectionData(data){if(data[0]===RtcPacs.messageTypes.viewer){if(this.viewerState.some((element,index)=>element!==data[1][index])){this.viewerState=data[1];this.viewerDirty=true}}else if(data[0]===RtcPacs.messageTypes.roster){let theirRoster=data[1];this.activeRoster.some(ourPeer=>{let isExtra=theirRoster.every(peer=>peer!==ourPeer);if(isExtra){let delay=Math.random()*5e3;setTimeout(this.broadcastRoster.bind(this),delay)}return isExtra});theirRoster.forEach(theirPeer=>{if(this.activeRoster.every(peer=>peer!==theirPeer)){let delay=Math.random()*5e3;setTimeout(this.connectTo.bind(this),delay,theirPeer)}})}else if(data[0]==RtcPacs.messageTypes.chat){this.saveChatMessage(data[1],data[2])}else if(data[0]==RtcPacs.messageTypes.control){if(data[2]){this.controlToggle=false;this.controlCodename=data[1].slice(RtcPacs.salt.length)}else{this.controlCodename=""}}else if(data[0]==RtcPacs.messageTypes.image){this.caseSelect=data[1]}}connectionClose(){this.refreshRosters()}callClose(){this.refreshRosters()}callStream(stream){let audioElement=new Audio;audioElement.srcObject=stream;audioElement.play();this.audioStreams.push(audioElement);this.refreshRosters()}connectTo(brokerId){if(!this.activeRoster.includes(brokerId)){let conn=this.peer.connect(brokerId);if(conn){conn.on("data",this.connectionData.bind(this));conn.on("open",this.connectionOpenOutgoing.bind(this));conn.on("close",this.connectionClose.bind(this));conn.on("error",RtcPacs.handleError)}else{}let call=this.peer.call(brokerId,this.audioStream,{sdpTransform:this.transformSdp});if(call){call.on("stream",this.callStream.bind(this));call.on("close",this.callClose.bind(this));call.on("error",RtcPacs.handleError)}else{}}else{}this.codename=""}refreshRosters(){this.rosterList=[];this.dataConnections=[];Object.keys(this.peer.connections).forEach(brokerId=>{let data=false;let audio=false;let connections=this.peer.connections[brokerId];connections.forEach(connection=>{if(connection.open){if(connection.type==="data"){data=true;this.dataConnections.push(connection)}else if(connection.type==="media"){audio=true}}});this.rosterList.push({codename:brokerId.startsWith(RtcPacs.salt)?brokerId.slice(RtcPacs.salt.length):brokerId,data:data,audio:audio})});this.activeRoster=this.rosterList.filter(conn=>conn.data||conn.audio).map(conn=>RtcPacs.salt+conn.codename);this.activeRoster.push(this.peer.id)}broadcastRoster(){this.dataConnections.forEach(conn=>conn.send([RtcPacs.messageTypes.roster,this.activeRoster]));if(this.controlToggle){this.takeControl()}}takeControl(){this.dataConnections.forEach(conn=>conn.send([RtcPacs.messageTypes.control,this.peer.id,true]));this.broadcastImage();setTimeout(()=>{this.broadcastViewer()},RtcPacs.broadcastImageDelay)}yieldControl(){this.dataConnections.forEach(conn=>conn.send([RtcPacs.messageTypes.control,this.peer.id,false]))}loadImage(){if(!this.viewerLinked){papayaContainers[0].viewer.registerDrawViewerCallback(this.broadcastViewer.bind(this));window.requestAnimationFrame(this.updateViewer.bind(this));this.viewerLinked=true}let url=this.caseSelect;papayaContainers[0].viewer.resetViewer();if(url){papayaContainers[0].viewer.loadBaseImage([url],true,false,false);papayaContainers[0].viewer.zoomFactor=1;this.updateZoomTransforms()}}broadcastImage(){this.dataConnections.forEach(conn=>conn.send([RtcPacs.messageTypes.image,this.caseSelect]))}updateViewer(timestamp){if(!this.controlToggle&&this.viewerDirty&&timestamp-this.lastViewerUpdate>RtcPacs.msPerFrame){papayaContainers[0].viewer.currentCoord.x=this.viewerState[0];papayaContainers[0].viewer.currentCoord.y=this.viewerState[1];papayaContainers[0].viewer.currentCoord.z=this.viewerState[2];papayaContainers[0].viewer.zoomFactor=this.viewerState[3];papayaContainers[0].viewer.zoomLocX=this.viewerState[4];papayaContainers[0].viewer.zoomLocY=this.viewerState[5];papayaContainers[0].viewer.zoomLocZ=this.viewerState[6];papayaContainers[0].viewer.panLocX=this.viewerState[7];papayaContainers[0].viewer.panLocY=this.viewerState[8];papayaContainers[0].viewer.panLocZ=this.viewerState[9];papayaContainers[0].viewer.panAmountX=this.viewerState[10];papayaContainers[0].viewer.panAmountY=this.viewerState[11];papayaContainers[0].viewer.panAmountZ=this.viewerState[12];if(papayaContainers[0].viewer.currentScreenVolume){papayaContainers[0].viewer.currentScreenVolume.screenMin=this.viewerState[13];papayaContainers[0].viewer.currentScreenVolume.screenMax=this.viewerState[14];papayaContainers[0].viewer.currentScreenVolume.screenRatio=this.viewerState[15]}papayaContainers[0].viewer.container.preferences.showCrosshairs=this.viewerState[16]?"Yes":"No";this.lastViewerUpdate=timestamp;this.viewerDirty=false;this.updateZoomTransforms();papayaContainers[0].viewer.drawViewer(true)}window.requestAnimationFrame(this.updateViewer.bind(this))}updateZoomTransforms(){let slices=[papayaContainers[0].viewer.axialSlice,papayaContainers[0].viewer.coronalSlice,papayaContainers[0].viewer.sagittalSlice];slices.forEach(slice=>{if(slice){slice.updateZoomTransform(papayaContainers[0].viewer.zoomFactor,papayaContainers[0].viewer.zoomLocX,papayaContainers[0].viewer.zoomLocY,papayaContainers[0].viewer.panAmountX,papayaContainers[0].viewer.panAmountY,papayaContainers[0].viewer)}})}broadcastViewer(){if(this.controlToggle){this.viewerState=[papayaContainers[0].viewer.currentCoord.x,papayaContainers[0].viewer.currentCoord.y,papayaContainers[0].viewer.currentCoord.z,papayaContainers[0].viewer.zoomFactor,papayaContainers[0].viewer.zoomLocX,papayaContainers[0].viewer.zoomLocY,papayaContainers[0].viewer.zoomLocZ,papayaContainers[0].viewer.panLocX,papayaContainers[0].viewer.panLocY,papayaContainers[0].viewer.panLocZ,papayaContainers[0].viewer.panAmountX,papayaContainers[0].viewer.panAmountY,papayaContainers[0].viewer.panAmountZ,papayaContainers[0].viewer.currentScreenVolume?papayaContainers[0].viewer.currentScreenVolume.screenMin:0,papayaContainers[0].viewer.currentScreenVolume?papayaContainers[0].viewer.currentScreenVolume.screenMax:100,papayaContainers[0].viewer.currentScreenVolume?papayaContainers[0].viewer.currentScreenVolume.screenRatio:1,papayaContainers[0].viewer.container.preferences.showCrosshairs==="Yes"];this.dataConnections.forEach(conn=>conn.send([RtcPacs.messageTypes.viewer,this.viewerState]))}}saveChatMessage(author,msg){this.chatroom.push({author:author.startsWith(RtcPacs.salt)?author.slice(RtcPacs.salt.length):author,msg:msg})}broadcastChatMessage(){this.saveChatMessage(this.peer.id,this.message);this.dataConnections.forEach(conn=>conn.send([RtcPacs.messageTypes.chat,this.peer.id,this.message]));this.message=""}transformSdp(sdp){return sdp}}_defineProperty(RtcPacs,"DEBUG",false);_defineProperty(RtcPacs,"adjectives",["Agile","Brilliant","Candid","Daring","Eager","Faithful","Gentle","Hungry","Ignorant","Jealous","Kind","Loyal","Majestic","Noisy","Optimistic","Proud","Quirky","Royal","Somber","Tidy","Ultimate","Vibrant","Worried","Youthful","Zesty"]);_defineProperty(RtcPacs,"animals",["Antelope","Beaver","Cheetah","Donkey","Elephant","Fox","Gorilla","Hawk","Iguana","Jaguar","Kangaroo","Leopard","Mongoose","Newt","Octopus","Penguin","Quail","Rooster","Shark","Tiger","Urchin","Vulture","Walrus","Yak","Zebra"]);_defineProperty(RtcPacs,"salt","qwnlcZsz-");_defineProperty(RtcPacs,"messageTypes",{viewer:0,roster:1,control:2,image:3,chat:4});_defineProperty(RtcPacs,"broadcastImageDelay",4e3);_defineProperty(RtcPacs,"msPerFrame",1e3/30);_defineProperty(RtcPacs,"microphoneStates",{none:0,unmuted:1,muted:2});let rtcpacs=new RtcPacs;var vm=new Vue({el:"#app",data:rtcpacs,computed:{peerCodeName:function(){return this.peer.id?this.peer.id.slice(RtcPacs.salt.length):"null"},peerCodeNameStyle:function(){return{"font-weight-bold":this.controlToggle,"text-primary":this.controlToggle}},peerBadgeStyle:function(){return{"badge-success":this.peer.open,"badge-warning":this.peer.disconnected&&!this.peer.destroyed,"badge-danger":this.peer.destroyed||!this.peer.open&&!this.peer.disconnected}},peerBadgeText:function(){if(this.peer.open){return"open"}else if(this.peer.destroyed){return"destroyed"}else if(this.peer.disconnected){return"disconnected"}else{return"error"}}},methods:{connect:function(event){let matchCodename=this.codename.toLowerCase().trim();let matchAdjective=RtcPacs.adjectives.find(element=>matchCodename.startsWith(element.toLowerCase()));let matchAnimal=RtcPacs.animals.find(element=>matchCodename.endsWith(element.toLowerCase()));let brokerId=matchAdjective&&matchAnimal?RtcPacs.salt+matchAdjective+matchAnimal:RtcPacs.salt+this.codename;this.$data.connectTo(brokerId)},sendChatMessage:function(event){this.$data.broadcastChatMessage()},changeControl:function(event){if(this.controlToggle){this.controlCodename=this.peerCodeName;this.$data.takeControl()}else{this.$data.yieldControl()}},connectionCodeNameStyle:function(connection){return{"font-weight-bold":connection.codename===this.controlCodename,"text-primary":connection.codename===this.controlCodename}},connectionBadgeStyle:function(connection,connectionType){return connection[connectionType]?"badge-success":"badge-danger"},messageStyle:function(message){return message.author===this.peerCodeName?"bg-light text-dark text-right ml-4":"bg-dark text-light text-left mr-4"},audioStatusToggle:function(){if(this.audioStream){let newState=!this.audioStream.getAudioTracks()[0].enabled;this.audioStream.getAudioTracks()[0].enabled=newState;this.microphoneState=newState?RtcPacs.microphoneStates.unmuted:RtcPacs.microphoneStates.muted}else{this.microphoneState=RtcPacs.microphoneStates.none}}},watch:{caseSelect:function(){this.$data.loadImage();if(this.$data.controlToggle){this.$data.broadcastImage();setTimeout(()=>{this.$data.broadcastViewer()},RtcPacs.broadcastImageDelay)}},chatroom:function(){this.$nextTick(()=>{this.$refs.chatroom.scrollTop=this.$refs.chatroom.scrollHeight})}}});
